---
phase: 01-database-schema
plan: 01
type: execute
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/types/alvin.ts
---

<objective>
Add Contact and Alert models to complete the ALVIN database schema.

Purpose: Enable family contact management and escalating alert system - the remaining core entities for the "dead man's switch" functionality.

Output: Complete Prisma schema with Contact and Alert models, TypeScript type definitions for string enums, regenerated Prisma client.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-database-schema/01-RESEARCH.md

@prisma/schema.prisma

**Context from Phase 5 execution:**
UserProfile, Conversation, Message, and CheckIn models already exist in the schema (added during Phase 5). Only Contact and Alert models remain to be added.

**From RESEARCH.md:**
- SQLite uses String for enums (not native enum type)
- Contact needs priority field for notification order
- Alert uses level String with documented values
- Soft delete for contacts (preserve data)
- No cascade delete on Alert (preserve audit trail)

**Established patterns:**
- `@default(cuid())` for IDs
- `@default(now())` and `@updatedAt` for timestamps
- Relations with `onDelete: Cascade` where appropriate
- Index on foreign keys and commonly queried fields
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Contact model to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add Contact model after the CheckIn model with these fields:
- id (cuid)
- userProfileId + relation to UserProfile with onDelete: Cascade
- name (String)
- email (String)
- phone (String?)
- relationship (String?) - values: "spouse", "child", "sibling", "friend", "other"
- priority (Int, default 999) - lower = notified first
- notifyByEmail (Boolean, default true)
- notifyBySms (Boolean, default false)
- deletedAt (DateTime?) - for soft delete
- createdAt, updatedAt

Add indexes:
- @@index([userProfileId, priority])
- @@index([userProfileId, deletedAt])

Also add `contacts Contact[]` relation to UserProfile model.
  </action>
  <verify>npx prisma validate passes</verify>
  <done>Contact model added with priority ordering and soft delete support</done>
</task>

<task type="auto">
  <name>Task 2: Add Alert model to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add Alert model after Contact model with these fields:
- id (cuid)
- userProfileId + relation to UserProfile (NO cascade - use SetNull to preserve audit trail)
- level (String, default "LEVEL_1") - documented values: LEVEL_1, LEVEL_2, LEVEL_3, LEVEL_4, CANCELLED, RESOLVED
- triggeredAt (DateTime, default now())
- lastEscalatedAt (DateTime?)
- resolvedAt (DateTime?) - when user checked in
- cancelledAt (DateTime?) - when user manually cancelled
- cancelReason (String?)
- createdAt, updatedAt

Add indexes:
- @@index([userProfileId, level])
- @@index([level, triggeredAt])

Also add `alerts Alert[]` relation to UserProfile model.

**Important:** Use `onDelete: SetNull` on the userProfile relation and make userProfileId optional (String?) to preserve alert records when user is deleted. This maintains the audit trail.
  </action>
  <verify>npx prisma validate passes</verify>
  <done>Alert model added with escalation levels and audit trail preservation</done>
</task>

<task type="auto">
  <name>Task 3: Create TypeScript enum types and run migration</name>
  <files>src/types/alvin.ts</files>
  <action>
1. Create src/types/alvin.ts with const objects for type-safe string enums:

```typescript
// Alert escalation levels
export const AlertLevel = {
  LEVEL_1: "LEVEL_1",
  LEVEL_2: "LEVEL_2",
  LEVEL_3: "LEVEL_3",
  LEVEL_4: "LEVEL_4",
  CANCELLED: "CANCELLED",
  RESOLVED: "RESOLVED",
} as const;
export type AlertLevel = (typeof AlertLevel)[keyof typeof AlertLevel];

// Check-in methods (already in use, now type-safe)
export const CheckInMethod = {
  MANUAL: "MANUAL",
  BIOMETRIC: "BIOMETRIC",
  CONVERSATION: "CONVERSATION",
} as const;
export type CheckInMethod = (typeof CheckInMethod)[keyof typeof CheckInMethod];

// Contact relationship types
export const ContactRelationship = {
  SPOUSE: "spouse",
  CHILD: "child",
  SIBLING: "sibling",
  FRIEND: "friend",
  OTHER: "other",
} as const;
export type ContactRelationship = (typeof ContactRelationship)[keyof typeof ContactRelationship];

// Message roles (already in use, now type-safe)
export const MessageRole = {
  USER: "user",
  ASSISTANT: "assistant",
} as const;
export type MessageRole = (typeof MessageRole)[keyof typeof MessageRole];
```

2. Run Prisma commands:
```bash
npx prisma db push
npx prisma generate
```
  </action>
  <verify>
1. npm run typecheck passes
2. npx prisma studio launches and shows Contact and Alert tables
  </verify>
  <done>
- Type definitions created in src/types/alvin.ts
- Prisma client regenerated with new models
- Database schema updated
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx prisma validate` passes
- [ ] `npx prisma db push` succeeds
- [ ] `npm run typecheck` passes
- [ ] Contact and Alert tables visible in `npx prisma studio`
</verification>

<success_criteria>

- Contact model with priority ordering and soft delete
- Alert model with level-based escalation and audit preservation
- TypeScript enum types for all string enum fields
- Prisma client regenerated
- All verification checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-database-schema/01-01-SUMMARY.md`:

# Phase 1 Plan 01: Database Schema Completion Summary

**[One-liner: what shipped]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `prisma/schema.prisma` - Added Contact and Alert models
- `src/types/alvin.ts` - TypeScript enum types for string enums

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 1 complete, ready for Phase 2 (User Profile Management)
</output>
