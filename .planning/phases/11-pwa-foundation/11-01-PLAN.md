---
phase: 11-pwa-foundation
plan: 01
type: execute
depends_on: []
files_modified: [package.json, tsconfig.json, next.config.mjs, src/app/sw.ts, src/app/manifest.ts, src/app/layout.tsx]
---

<objective>
Set up core PWA infrastructure with Serwist service worker and Next.js manifest.

Purpose: Enable ALVIN to be installed as a native-like mobile app with service worker caching.
Output: Working PWA configuration that can be installed on home screen.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-pwa-foundation/11-RESEARCH.md

**Key research findings:**
- Use `@serwist/next` (not deprecated next-pwa)
- Service worker source in `src/app/sw.ts`, compiled to `public/sw.js`
- Use Next.js built-in `app/manifest.ts` for type-safe manifest
- Disable service worker in development (Turbopack incompatible)
- Use `defaultCache` from Serwist for Next.js-optimized caching

**Existing files to modify:**
@next.config.js
@src/app/layout.tsx
@tsconfig.json
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Serwist dependencies and update TypeScript config</name>
  <files>package.json, tsconfig.json</files>
  <action>
    1. Install dependencies:
       ```bash
       npm i @serwist/next && npm i -D serwist
       ```

    2. Update tsconfig.json compilerOptions:
       - Add "webworker" to the "lib" array
       - Add "@serwist/next/typings" to a new "types" array

    The lib array should be: ["dom", "dom.iterable", "ES2022", "webworker"]
    Add types: ["@serwist/next/typings"]
  </action>
  <verify>npm ls @serwist/next serwist shows both packages installed; tsc --noEmit passes</verify>
  <done>Serwist packages installed, TypeScript configured for service worker development</done>
</task>

<task type="auto">
  <name>Task 2: Create service worker and configure Next.js build</name>
  <files>src/app/sw.ts, next.config.mjs, package.json</files>
  <action>
    1. Delete next.config.js and create next.config.mjs with Serwist wrapper:
       ```javascript
       import withSerwistInit from "@serwist/next";
       import "./src/env.js";

       const withSerwist = withSerwistInit({
         swSrc: "src/app/sw.ts",
         swDest: "public/sw.js",
         cacheOnNavigation: true,
         register: true,
         scope: "/",
         disable: process.env.NODE_ENV === "development",
         reloadOnOnline: true,
       });

       /** @type {import("next").NextConfig} */
       const nextConfig = {};

       export default withSerwist(nextConfig);
       ```

    2. Create src/app/sw.ts service worker:
       ```typescript
       import { defaultCache } from "@serwist/next/worker";
       import type { PrecacheEntry, SerwistGlobalConfig } from "serwist";
       import { Serwist } from "serwist";

       declare global {
         interface WorkerGlobalScope extends SerwistGlobalConfig {
           __SW_MANIFEST: (PrecacheEntry | string)[] | undefined;
         }
       }

       declare const self: ServiceWorkerGlobalScope;

       const serwist = new Serwist({
         precacheEntries: self.__SW_MANIFEST,
         skipWaiting: true,
         clientsClaim: true,
         navigationPreload: true,
         runtimeCaching: defaultCache,
         fallbacks: {
           entries: [
             {
               url: "/offline",
               matcher({ request }) {
                 return request.destination === "document";
               },
             },
           ],
         },
       });

       serwist.addEventListeners();
       ```

    3. Add dev:pwa script to package.json scripts (Turbopack incompatible with Serwist):
       "dev:pwa": "next dev"

    Keep the existing "dev": "next dev --turbo" for fast development without PWA.
  </action>
  <verify>npm run build completes without errors; public/sw.js is generated</verify>
  <done>Service worker configured, build generates sw.js, dev:pwa script available for PWA testing</done>
</task>

<task type="auto">
  <name>Task 3: Create PWA manifest and update layout metadata</name>
  <files>src/app/manifest.ts, src/app/layout.tsx</files>
  <action>
    1. Create src/app/manifest.ts with ALVIN branding:
       ```typescript
       import type { MetadataRoute } from "next";

       export default function manifest(): MetadataRoute.Manifest {
         return {
           name: "ALVIN - Vitality Monitor",
           short_name: "ALVIN",
           description: "AI-powered vitality monitoring for peace of mind",
           start_url: "/",
           display: "standalone",
           background_color: "#15162c",
           theme_color: "#2e026d",
           orientation: "portrait-primary",
           icons: [
             {
               src: "/icon-192x192.png",
               sizes: "192x192",
               type: "image/png",
             },
             {
               src: "/icon-512x512.png",
               sizes: "512x512",
               type: "image/png",
             },
             {
               src: "/apple-touch-icon.png",
               sizes: "180x180",
               type: "image/png",
               purpose: "any",
             },
           ],
         };
       }
       ```

    2. Update src/app/layout.tsx metadata and add viewport export:
       - Change title from "Create T3 App" to ALVIN
       - Add applicationName, description, appleWebApp config
       - Export viewport with theme color

       Replace the metadata export with:
       ```typescript
       export const metadata: Metadata = {
         applicationName: "ALVIN",
         title: {
           default: "ALVIN",
           template: "%s | ALVIN",
         },
         description: "AI-powered vitality monitoring for peace of mind",
         appleWebApp: {
           capable: true,
           statusBarStyle: "default",
           title: "ALVIN",
         },
         formatDetection: {
           telephone: false,
         },
         icons: [
           { rel: "icon", url: "/favicon.ico" },
           { rel: "apple-touch-icon", url: "/apple-touch-icon.png" },
         ],
       };

       export const viewport: Viewport = {
         themeColor: "#2e026d",
         width: "device-width",
         initialScale: 1,
         maximumScale: 1,
       };
       ```

       Add Viewport to the import: import { type Metadata, type Viewport } from "next";
  </action>
  <verify>npm run build succeeds; visiting /manifest.webmanifest returns valid JSON</verify>
  <done>PWA manifest created with ALVIN branding, layout has proper PWA metadata</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `public/sw.js` is generated after build
- [ ] `npm run typecheck` passes
- [ ] Manifest accessible at /manifest.webmanifest (after build + start)
</verification>

<success_criteria>
- All tasks completed
- Serwist packages installed and configured
- Service worker builds successfully
- PWA manifest has ALVIN branding
- Layout has proper mobile/PWA metadata
</success_criteria>

<output>
After completion, create `.planning/phases/11-pwa-foundation/11-01-SUMMARY.md`
</output>
