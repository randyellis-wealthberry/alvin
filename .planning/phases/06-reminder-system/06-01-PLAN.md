---
phase: 06-reminder-system
plan: 01
type: execute
depends_on: []
files_modified: [src/lib/reminders/eligibility.ts, src/app/api/cron/reminders/route.ts, vercel.json, src/env.js]
---

<objective>
Set up Vercel Cron infrastructure and reminder eligibility logic.

Purpose: Create the scheduled job foundation that identifies users who need check-in reminders.
Output: Working cron endpoint that calculates reminder eligibility, secured with CRON_SECRET.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior phase context:**
@.planning/phases/02-user-profile-management/02-01-SUMMARY.md

**Key source files:**
@prisma/schema.prisma
@src/server/api/routers/profile.ts
@src/env.js

**Tech stack available:**
- Next.js 15 App Router
- Prisma with SQLite
- tRPC for API

**Established patterns:**
- Protected procedures with session context
- Rate limiting on mutations
- Environment validation via @t3-oss/env-nextjs

**Schema fields for reminders:**
- UserProfile.lastCheckInAt - last check-in timestamp
- UserProfile.nextCheckInDue - can be updated when calculating due time
- UserProfile.checkInFrequencyHours - interval (1-168 hours)
- UserProfile.preferredCheckInTime - optional "HH:MM" format
- UserProfile.timezone - user timezone (default UTC)
- UserProfile.isActive - whether monitoring is enabled
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reminder eligibility module</name>
  <files>src/lib/reminders/eligibility.ts</files>
  <action>
Create a module that calculates which users need reminders:

1. Export `findUsersNeedingReminders()` function that:
   - Queries UserProfile where isActive=true
   - Includes User relation for email
   - Calculates if reminder is due based on:
     - lastCheckInAt + checkInFrequencyHours < now = overdue
     - If preferredCheckInTime set, factor in timezone
   - Returns array of users with their profile and email

2. Export `calculateNextCheckInDue(profile)` helper that:
   - Takes a UserProfile
   - Returns Date of when next check-in is due
   - Considers preferredCheckInTime and timezone if set

Use Prisma client from ~/server/db.ts. Keep logic pure and testable.
Do NOT import tRPC context - this runs outside request context.
  </action>
  <verify>TypeScript compiles: npm run typecheck</verify>
  <done>Module exports findUsersNeedingReminders and calculateNextCheckInDue functions</done>
</task>

<task type="auto">
  <name>Task 2: Create cron API endpoint with security</name>
  <files>src/app/api/cron/reminders/route.ts, src/env.js</files>
  <action>
Create secure cron endpoint:

1. Add CRON_SECRET to src/env.js:
   - Add to server schema: CRON_SECRET: z.string().min(1)
   - Add to runtimeEnv: CRON_SECRET: process.env.CRON_SECRET

2. Create src/app/api/cron/reminders/route.ts:
   - Export GET handler (Vercel Cron uses GET)
   - Check Authorization header: `Bearer ${env.CRON_SECRET}`
   - Return 401 if invalid
   - Call findUsersNeedingReminders()
   - For now, log users who need reminders (email sending comes in 06-02)
   - Return JSON with count and success status

Security: Always validate CRON_SECRET. Never expose user data in response.
  </action>
  <verify>
curl -X GET http://localhost:3000/api/cron/reminders returns 401 (no auth)
curl -X GET http://localhost:3000/api/cron/reminders -H "Authorization: Bearer test-secret" returns 200 (with CRON_SECRET=test-secret in .env)
  </verify>
  <done>Endpoint returns 401 without auth, 200 with valid CRON_SECRET, logs eligible users</done>
</task>

<task type="auto">
  <name>Task 3: Add vercel.json cron configuration</name>
  <files>vercel.json</files>
  <action>
Create or update vercel.json with cron configuration:

```json
{
  "$schema": "https://openapi.vercel.sh/vercel.json",
  "crons": [
    {
      "path": "/api/cron/reminders",
      "schedule": "0 * * * *"
    }
  ]
}
```

Schedule "0 * * * *" = runs at minute 0 of every hour.
This checks hourly for users who need reminders.

Note: Vercel automatically adds CRON_SECRET to environment and sends it as Authorization header.
For local testing, set CRON_SECRET manually in .env.
  </action>
  <verify>vercel.json exists and is valid JSON with crons array</verify>
  <done>vercel.json configured with hourly cron job for /api/cron/reminders</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run typecheck passes
- [ ] npm run lint passes
- [ ] Cron endpoint returns 401 without Authorization header
- [ ] Cron endpoint returns 200 with valid Bearer token
- [ ] vercel.json has valid cron configuration
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Cron infrastructure ready for email integration in 06-02
- CRON_SECRET added to environment validation
</success_criteria>

<output>
After completion, create `.planning/phases/06-reminder-system/06-01-SUMMARY.md`
</output>
