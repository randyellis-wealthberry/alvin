---
phase: 08-contact-notifications
plan: 02
type: execute
depends_on: ["08-01"]
files_modified: [src/app/api/cron/escalation/route.ts]
---

<objective>
Integrate contact notifications into the escalation cron so alerts at L3 and L4 trigger emails to family contacts.

Purpose: Complete the alert escalation loop by actually notifying family contacts when alerts reach critical levels.
Output: Modified escalation cron that sends notifications on L3/L4 transitions.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-contact-notifications/08-RESEARCH.md
@.planning/phases/08-contact-notifications/08-01-SUMMARY.md

# Existing cron to modify
@src/app/api/cron/escalation/route.ts

# Notification functions to use (from 08-01)
@src/lib/alerts/notifications.ts

# Contact model for fetching
@prisma/schema.prisma

**Established patterns:**
- Escalation cron runs hourly, processes all alerts needing escalation
- Each escalation is logged clearly
- CRON_SECRET required for auth
- Individual failure handling (one failure doesn't stop others)

**Key research findings (from 08-RESEARCH.md):**
- Send notifications AFTER level update (ensures atomic, no duplicate sends)
- L3: Call notifyPrimaryContact (single email)
- L4: Call notifyAllContacts (batch send)
- Include contacts fetch in escalation loop for each alert
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modify escalation cron to send notifications on L3/L4</name>
  <files>src/app/api/cron/escalation/route.ts</files>
  <action>
Modify the escalation cron to call notification functions when alerts transition to L3 or L4:

1. Import notification functions:
   ```typescript
   import { notifyPrimaryContact, notifyAllContacts } from "~/lib/alerts/notifications";
   ```

2. In the escalation loop (after updating alert level), add notification logic:

   After `await db.alert.update(...)` in the escalation loop:
   ```typescript
   // Send notifications for L3 and L4 transitions
   if (nextLevel === "LEVEL_3" || nextLevel === "LEVEL_4") {
     // Fetch profile with user for name, and contacts for notifications
     const profileWithUserAndContacts = await db.userProfile.findUnique({
       where: { id: alert.userProfileId },
       include: {
         user: true,
         contacts: true,
       },
     });

     if (profileWithUserAndContacts) {
       if (nextLevel === "LEVEL_3") {
         await notifyPrimaryContact(
           { ...alert, level: nextLevel },
           profileWithUserAndContacts,
           profileWithUserAndContacts.contacts
         );
       } else if (nextLevel === "LEVEL_4") {
         await notifyAllContacts(
           { ...alert, level: nextLevel },
           profileWithUserAndContacts,
           profileWithUserAndContacts.contacts
         );
       }
     }
   }
   ```

3. Update the NOTE comment at the top (line ~21) to indicate notifications are now implemented:
   - Remove: "Note: Contact notifications (L3/L4) will be added in Phase 8."
   - The comment is now outdated.

4. Add notification counts to the response (optional enhancement):
   - Track: notificationsL3, notificationsL4 counts
   - Add to response JSON alongside alertsCreated/alertsEscalated

Why AFTER level update: If cron fails between update and notification, re-run will correctly detect the alert is already at L3/L4 and won't re-escalate. Notifications only trigger on transitions, preventing duplicates.

Handle errors gracefully - notification failures should log but not crash the cron. The notification functions already handle their own errors internally.
  </action>
  <verify>
    - npm run typecheck passes
    - npm run lint:fix passes
    - npm run build succeeds
  </verify>
  <done>Escalation cron modified to send L3/L4 notifications, builds successfully</done>
</task>

<task type="auto">
  <name>Task 2: Verify complete integration</name>
  <files>src/app/api/cron/escalation/route.ts</files>
  <action>
Verify the complete integration works correctly:

1. Run the full check suite:
   ```bash
   npm run check
   ```
   This runs lint + typecheck. Both must pass.

2. Run the build:
   ```bash
   npm run build
   ```
   Must succeed without errors.

3. Review the escalation flow logic:
   - L1 → L2: No notification (internal escalation)
   - L2 → L3: Notify primary contact only
   - L3 → L4: Notify all contacts (batch)
   - L4: Terminal, no further escalation

4. Confirm the notification flow:
   - Contacts are fetched fresh during escalation (includes new contacts, excludes deleted)
   - Profile includes user for userName in emails
   - Each notification function handles its own logging and error cases

5. If any issues found, fix them. The goal is a clean, working integration.
  </action>
  <verify>
    - npm run check passes (lint + typecheck)
    - npm run build succeeds
  </verify>
  <done>Complete integration verified, all checks pass, build succeeds</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run check` passes (lint + typecheck)
- [ ] `npm run build` succeeds
- [ ] Escalation cron correctly calls notifyPrimaryContact on L3 transition
- [ ] Escalation cron correctly calls notifyAllContacts on L4 transition
- [ ] No duplicate notification logic (triggers only on transition, not on re-runs)
</verification>

<success_criteria>
- Escalation to L3 triggers notification to primary contact
- Escalation to L4 triggers notification to all contacts via batch API
- Cron continues processing other alerts even if one notification fails
- Build and all checks pass
- Phase 8 complete
</success_criteria>

<output>
After completion, create `.planning/phases/08-contact-notifications/08-02-SUMMARY.md` following summary.md template.

Include in summary:
- Key files modified
- Integration pattern used
- Notification flow documented
- Phase 8 complete status
</output>
