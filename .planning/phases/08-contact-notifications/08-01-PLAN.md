---
phase: 08-contact-notifications
plan: 01
type: execute
depends_on: []
files_modified: [src/emails/ContactAlertEmail.tsx, src/lib/alerts/notifications.ts]
---

<objective>
Create the email template and notification module for alert contact notifications.

Purpose: Provide urgency-appropriate email templates for L3 (concerned) and L4 (urgent) alerts, plus the notification logic to send them to the right contacts.
Output: ContactAlertEmail component and notifications module with notifyPrimaryContact/notifyAllContacts functions.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-contact-notifications/08-RESEARCH.md

# Prior phase patterns
@.planning/phases/06-reminder-system/06-02-SUMMARY.md
@.planning/phases/07-alert-escalation-engine/07-01-SUMMARY.md

# Existing email template pattern
@src/emails/ReminderEmail.tsx

# Contact model for reference
@prisma/schema.prisma (Contact model: name, email, priority, deletedAt, notifyByEmail)

**Established patterns:**
- React Email with inline styles for email client compatibility
- RESEND_API_KEY optional for development flexibility
- Individual email failure handling (continue on error)
- Contact priority: lower number = higher priority

**Key research findings (from 08-RESEARCH.md):**
- L3: Notify only primary contact (lowest priority number)
- L4: Use resend.batch.send() for all contacts (up to 100 emails)
- Tone: L3 = concerned ("haven't heard from"), L4 = urgent ("please contact")
- Filter: deletedAt === null && notifyByEmail && email
- Tags for tracking: { name: "alert_id", value: alertId }
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ContactAlertEmail component</name>
  <files>src/emails/ContactAlertEmail.tsx</files>
  <action>
Create a React Email template for alert notifications following the ReminderEmail pattern:

1. Props interface: contactName, userName, alertLevel ("L3" | "L4"), lastCheckIn (formatted string)
2. L3 variant: Concerned tone
   - Preview: "We haven't heard from {userName}"
   - Heading: "Wellness Check Request"
   - Body: "We haven't heard from {userName} in a while. Their last check-in was {lastCheckIn}."
   - CTA: "If you have a chance, please check in with them"
3. L4 variant: Urgent tone
   - Preview: "Urgent: Please contact {userName}"
   - Heading: "Urgent Alert"
   - Body: "We haven't been able to reach {userName} for an extended period. Their last check-in was {lastCheckIn}."
   - CTA: "Please attempt to contact them as soon as possible"
4. Footer explaining what ALVIN is (brief, one line)
5. Use same inline styles as ReminderEmail (bodyStyle, containerStyle, headingStyle, paragraphStyle, footerTextStyle)
6. NO button/CTA button needed - this is informational, not actionable by clicking

Why no button: Unlike reminders where the user can click to check-in, contacts cannot take action in the app. The email is purely informational, prompting them to reach out via phone/text.

Export both the component and a default export for React Email preview compatibility.
  </action>
  <verify>
    - npm run typecheck passes
    - File exports ContactAlertEmail component
  </verify>
  <done>ContactAlertEmail.tsx created with L3/L4 variants, proper typing, inline styles</done>
</task>

<task type="auto">
  <name>Task 2: Create notifications module</name>
  <files>src/lib/alerts/notifications.ts</files>
  <action>
Create the notification functions that the escalation cron will call:

1. Import: Resend, ContactAlertEmail, Contact/Alert types from Prisma
2. Create resend client (same pattern as reminders/route.ts):
   ```typescript
   const resend = env.RESEND_API_KEY ? new Resend(env.RESEND_API_KEY) : null;
   ```

3. Helper: formatLastCheckIn(date: Date | null): string
   - If null: "never"
   - Else: relative time like "2 days ago", "3 hours ago" using simple logic (no library)

4. Function: notifyPrimaryContact(alert, profile, contacts)
   - Filter contacts: deletedAt === null && notifyByEmail && email
   - Sort by priority ascending, take first (lowest = highest priority)
   - If no eligible contact: log and return { success: false, error: "No eligible contact" }
   - If no resend client: log warning and return { success: false, error: "Email not configured" }
   - Send single email via resend.emails.send() with:
     - from: "ALVIN Alert <alerts@resend.dev>"
     - to: primaryContact.email
     - subject: "We haven't heard from {userName}"
     - react: ContactAlertEmail with L3 props
     - tags: [{ name: "alert_id", value: alert.id }, { name: "level", value: "LEVEL_3" }]
   - Return { success: true, email: primaryContact.email } or { success: false, error: message }

5. Function: notifyAllContacts(alert, profile, contacts)
   - Filter contacts: deletedAt === null && notifyByEmail && email
   - If no eligible contacts: log and return { sent: 0, failed: 0 }
   - If no resend client: log warning and return { sent: 0, failed: 0 }
   - Build batch email array with same structure (L4 props)
   - Send via resend.batch.send()
   - Return { sent: eligibleContacts.length, failed: 0 } on success, or { sent: 0, failed: count } on error

6. Both functions should:
   - Log actions clearly: `[Notification] Notifying primary contact: {email}`
   - Handle errors gracefully (catch and log, don't throw)
   - Accept profile with nested user for userName access

Type hints:
- profile: UserProfile & { user: User }
- contacts: Contact[]
- alert: Alert
  </action>
  <verify>
    - npm run typecheck passes
    - File exports notifyPrimaryContact and notifyAllContacts functions
    - npm run lint:fix passes (fix any lint issues)
  </verify>
  <done>notifications.ts module created with both notification functions, proper error handling, logging</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` passes
- [ ] `npm run lint:fix` passes
- [ ] ContactAlertEmail.tsx exists with proper exports
- [ ] notifications.ts exists with both functions exported
</verification>

<success_criteria>
- Email template renders L3 and L4 variants based on alertLevel prop
- notifyPrimaryContact sends to contact with lowest priority number
- notifyAllContacts uses batch API for all eligible contacts
- Both functions handle missing email config gracefully
- All types are correct, no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-contact-notifications/08-01-SUMMARY.md` following summary.md template.
</output>
