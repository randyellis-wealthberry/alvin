---
phase: 02-user-profile-management
plan: 01
type: execute
depends_on: []
files_modified:
  - src/server/api/routers/profile.ts
  - src/server/api/root.ts
  - src/app/profile/page.tsx
  - src/app/profile/profile-form.tsx
---

<objective>
Create user profile management with check-in schedule configuration.

Purpose: Enable users to configure their check-in frequency and preferred times - the core settings for ALVIN's "dead man's switch" functionality.

Output: Profile tRPC router with get/update operations, profile settings page with form for check-in preferences.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-database-schema/01-01-SUMMARY.md

**Existing patterns:**
@src/server/api/routers/post.ts - Router pattern with protectedProcedure
@src/server/api/root.ts - Router registration
@prisma/schema.prisma - UserProfile model already exists

**Tech stack available:**
- tRPC with protectedProcedure for authenticated routes
- Zod for input validation
- Prisma for database operations
- React Server Components for SSR
- Tailwind CSS for styling

**Established patterns:**
- const as const for SQLite-compatible enums (src/types/alvin.ts)
- protectedProcedure for authenticated operations
- useSuspenseQuery for SSR-compatible queries
- Path alias ~/

**Key decisions from Phase 1:**
- UserProfile model exists with: checkInFrequencyHours, preferredCheckInTime, timezone, isActive
- Use existing model fields, no schema changes needed
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create profile tRPC router</name>
  <files>src/server/api/routers/profile.ts, src/server/api/root.ts</files>
  <action>
Create profile router with two procedures:

1. `get` - protectedProcedure that returns user's profile or creates one if it doesn't exist (upsert pattern):
   - Query UserProfile by userId (from ctx.session.user.id)
   - If not found, create with defaults: checkInFrequencyHours=24, timezone="UTC", isActive=true
   - Return profile data

2. `update` - protectedProcedure with Zod input validation:
   - Input: { checkInFrequencyHours: z.number().min(1).max(168), preferredCheckInTime: z.string().regex(/^\d{2}:\d{2}$/).optional(), timezone: z.string(), isActive: z.boolean() }
   - Update UserProfile for current user
   - Use rateLimitMiddleware on mutation
   - Return updated profile

Register router in root.ts as `profile: profileRouter`.

Follow existing post.ts patterns exactly for imports and structure.
  </action>
  <verify>npm run typecheck passes</verify>
  <done>Profile router created with get and update procedures, registered in root.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create profile settings page and form</name>
  <files>src/app/profile/page.tsx, src/app/profile/profile-form.tsx</files>
  <action>
Create protected profile page at /profile:

1. `src/app/profile/page.tsx` (Server Component):
   - Import auth, redirect unauthorized users to /api/auth/signin
   - Prefetch profile data via api.profile.get.prefetch()
   - Render ProfileForm client component with HydrateClient wrapper
   - Use similar styling to existing pages (dark gradient background)

2. `src/app/profile/profile-form.tsx` (Client Component with "use client"):
   - Fetch profile with api.profile.get.useSuspenseQuery()
   - Form with inputs for:
     * Check-in frequency (number input, 1-168 hours, default 24)
     * Preferred check-in time (time input, HH:MM format, optional)
     * Timezone (select dropdown with common timezones)
     * Active status (checkbox)
   - Submit button that calls api.profile.update.useMutation()
   - Show success/error feedback after submission
   - Use Tailwind for styling matching existing app aesthetic

Common timezones for dropdown: UTC, America/New_York, America/Chicago, America/Denver, America/Los_Angeles, Europe/London, Europe/Paris, Asia/Tokyo, Australia/Sydney

Follow existing component patterns from src/app/_components/post.tsx and src/app/chat/.
  </action>
  <verify>npm run build succeeds, navigating to /profile shows form when authenticated</verify>
  <done>Profile page renders form, form submits and updates database correctly</done>
</task>

<task type="auto">
  <name>Task 3: Add profile link to navigation</name>
  <files>src/app/page.tsx</files>
  <action>
Add a link to the profile page in the home page for authenticated users:

1. In the authenticated section (where "Logged in as {name}" appears), add:
   - Link to /profile with text "Settings" or "Profile Settings"
   - Style consistently with existing "Sign out" link (rounded-full bg-white/10 etc.)
   - Position appropriately in the flex layout

This provides navigation to the new profile page.
  </action>
  <verify>When logged in, profile link appears and navigates to /profile</verify>
  <done>Profile link visible for authenticated users, navigates correctly</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` passes
- [ ] `npm run build` succeeds
- [ ] Profile page accessible at /profile when authenticated
- [ ] Profile form loads existing data (or defaults for new users)
- [ ] Form submission updates database and shows success feedback
- [ ] Unauthenticated users redirected to sign-in
</verification>

<success_criteria>

- Profile tRPC router with get and update procedures
- Profile settings page with check-in configuration form
- Profile link in navigation for authenticated users
- All verification checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-user-profile-management/02-01-SUMMARY.md`:

# Phase 2 Plan 01: User Profile Management Summary

**[One-liner: what shipped]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `src/server/api/routers/profile.ts` - Profile router with get/update
- `src/server/api/root.ts` - Router registration
- `src/app/profile/page.tsx` - Profile settings page
- `src/app/profile/profile-form.tsx` - Settings form component
- `src/app/page.tsx` - Added profile link

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 2 complete, ready for Phase 3 (Contact Management)
</output>
