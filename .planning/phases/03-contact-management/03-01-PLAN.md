---
phase: 03-contact-management
plan: 01
type: execute
depends_on: []
files_modified:
  - src/server/api/routers/contact.ts
  - src/server/api/root.ts
  - src/app/contacts/page.tsx
  - src/app/contacts/contact-list.tsx
  - src/app/contacts/contact-form.tsx
  - src/app/page.tsx
---

<objective>
Implement family contact management with full CRUD operations and notification preferences.

Purpose: Allow users to add, edit, and remove trusted contacts who will be notified during alert escalation (Phases 7-8).
Output: tRPC contact router, /contacts page with list and add/edit form, navigation link.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context (patterns to follow):
@.planning/phases/01-database-schema/01-01-SUMMARY.md
@.planning/phases/02-user-profile-management/02-01-SUMMARY.md

# Existing patterns to replicate:
@src/server/api/routers/profile.ts
@src/app/profile/page.tsx
@src/app/profile/profile-form.tsx

# Schema reference:
@prisma/schema.prisma

**Established patterns from prior phases:**
- Rate limiting on mutations only (not queries)
- Protected procedures for authenticated endpoints
- useSuspenseQuery for SSR-compatible data fetching
- Form success feedback with auto-clear timeout
- Soft delete via deletedAt timestamp (Contact model)
- Priority ordering: lower number = higher priority

**Key decisions:**
- Contact soft delete preserves notification history (Phase 1)
- Relationship field is optional string with predefined values
- Priority default 999 allows easy insertion before existing contacts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create contact tRPC router</name>
  <files>src/server/api/routers/contact.ts, src/server/api/root.ts</files>
  <action>
Create contact router with these procedures:

1. `list` - protectedProcedure query
   - Find user's profile first (error if not exists)
   - Return all contacts where userProfileId matches AND deletedAt is null
   - Order by priority ASC (lower = first)

2. `create` - protectedProcedure with rateLimitMiddleware mutation
   - Input: name (string, required), email (string, email format), phone (string, optional), relationship (string, optional), priority (number, optional, default 999), notifyByEmail (boolean, default true), notifyBySms (boolean, default false)
   - Find or create user's profile (like profile.get pattern)
   - Create contact linked to profile

3. `update` - protectedProcedure with rateLimitMiddleware mutation
   - Input: id (string), plus all fields from create (all optional)
   - Verify contact belongs to user's profile before updating
   - Update only provided fields

4. `delete` - protectedProcedure with rateLimitMiddleware mutation
   - Input: id (string)
   - Verify contact belongs to user's profile
   - Soft delete: set deletedAt to now(), do NOT hard delete

Register router in root.ts as `contact: contactRouter`.

Use Zod for input validation. Follow profile.ts patterns exactly for procedure structure.
  </action>
  <verify>npm run typecheck passes, router exports correctly</verify>
  <done>Contact router with list/create/update/delete procedures, registered in root.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create contacts page with list and form</name>
  <files>src/app/contacts/page.tsx, src/app/contacts/contact-list.tsx, src/app/contacts/contact-form.tsx</files>
  <action>
Create /contacts route with three files:

1. `page.tsx` (Server Component):
   - Follow profile/page.tsx pattern exactly
   - Prefetch contact.list via createCaller
   - HydrateClient wrapper around ContactList
   - Protected: redirect if not authenticated

2. `contact-list.tsx` (Client Component):
   - "use client" directive
   - useSuspenseQuery for contact.list
   - Display contacts in card grid or list format
   - Each contact shows: name, email, phone (if set), relationship badge, priority number
   - Edit button per contact (opens form in edit mode)
   - Delete button with confirmation (uses soft delete mutation)
   - "Add Contact" button at top (opens form in create mode)
   - Empty state: "No contacts yet. Add your first trusted contact."

3. `contact-form.tsx` (Client Component):
   - "use client" directive
   - Props: contact (optional - for edit mode), onClose callback
   - Modal/overlay pattern OR inline form that expands
   - Fields: name, email, phone, relationship (dropdown: spouse, child, sibling, parent, friend, other), priority (number), notifyByEmail (checkbox), notifyBySms (checkbox, disabled with "Coming soon" label)
   - Create or update based on whether contact prop exists
   - Success feedback like profile-form.tsx pattern
   - Close form on success after brief delay

Styling: Match existing dark theme (bg-white/10, rounded-xl, white text). Use Tailwind only.

RELATIONSHIP_OPTIONS constant: ["spouse", "child", "sibling", "parent", "friend", "other"]
  </action>
  <verify>npm run dev, visit /contacts, can add/edit/delete contacts</verify>
  <done>Contacts page renders, CRUD operations work, soft delete confirmed</done>
</task>

<task type="auto">
  <name>Task 3: Add contacts link to navigation</name>
  <files>src/app/page.tsx</files>
  <action>
Add "Contacts" link next to existing "Settings" link in home page navigation.

Follow same pattern as Settings link:
- Only show when authenticated (inside the session check)
- Same styling as Settings link
- Link to /contacts

Order: Settings | Contacts (or Contacts | Settings - either is fine)
  </action>
  <verify>npm run dev, see Contacts link when logged in, click navigates to /contacts</verify>
  <done>Contacts link visible for authenticated users, navigates correctly</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` passes
- [ ] `npm run lint` passes (or only pre-existing warnings)
- [ ] Can add a new contact with all fields
- [ ] Can edit an existing contact
- [ ] Can delete a contact (soft delete - verify deletedAt set in DB)
- [ ] Contact list shows all non-deleted contacts
- [ ] Contacts link appears in navigation when logged in
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Contact CRUD fully functional
- Soft delete working (deletedAt timestamp, not hard delete)
- UI matches existing dark theme
</success_criteria>

<output>
After completion, create `.planning/phases/03-contact-management/03-01-SUMMARY.md` following the summary template with:
- Performance metrics (duration, files modified)
- Task commits (one per task)
- Decisions made during implementation
- Any deviations from plan
- Next phase readiness
</output>
