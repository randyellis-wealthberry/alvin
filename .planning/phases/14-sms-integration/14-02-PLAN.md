---
phase: 14-sms-integration
plan: 02
type: execute
depends_on: ["14-01"]
files_modified:
  - src/lib/alerts/notifications.ts
  - src/app/api/cron/reminders/route.ts
  - src/app/api/cron/escalation/route.ts
  - src/lib/reminders/eligibility.ts
---

<objective>
Integrate SMS notifications for family contacts (L3/L4 escalation) and user reminders.

Purpose: Complete SMS notification coverage - family contacts receive SMS alerts, users receive SMS reminders as fallback.
Output: SMS sent to eligible family contacts at L3/L4, SMS fallback for user reminders.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-sms-integration/14-01-SUMMARY.md

# Key source files:
@src/lib/alerts/notifications.ts
@src/app/api/cron/reminders/route.ts
@src/app/api/cron/escalation/route.ts
@src/lib/reminders/eligibility.ts

**Tech stack available:**
- Twilio SMS service (from 14-01)
- Vercel Cron for scheduling
- Resend for email
- Web Push for push notifications

**Established patterns:**
- Contact eligibility filtering: deletedAt === null && notifyBy* && has_field
- Push-first, email-fallback, SMS-fallback notification pattern
- Urgency-based notification variants: L3=concerned, L4=urgent

**Constraining decisions:**
- Phase 14-01: sendSMS function with E.164 phone format requirement
- Phase 08: L3 sends to primary contact only, L4 sends to all contacts (batch)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SMS support to family contact notifications</name>
  <files>src/lib/alerts/notifications.ts</files>
  <action>
Update src/lib/alerts/notifications.ts to send SMS to family contacts:

1. Import sendSMS from ~/lib/sms:
   ```typescript
   import { sendSMS } from "~/lib/sms";
   ```

2. Create SMS message templates (plain text):
   ```typescript
   const SMS_TEMPLATES = {
     L3: (contactName: string, userName: string, lastCheckIn: string) =>
       `Hi ${contactName}, ALVIN hasn't heard from ${userName} since ${lastCheckIn}. This is a courtesy notification - please reach out when you can.`,
     L4: (contactName: string, userName: string, lastCheckIn: string) =>
       `URGENT: ${contactName}, ${userName} has not responded to ALVIN for an extended period (last check-in: ${lastCheckIn}). Please contact them immediately.`,
   };
   ```

3. Add helper function getEligibleContactsForSms:
   ```typescript
   function getEligibleContactsForSms(contacts: Contact[]): Contact[] {
     return contacts.filter(
       (c) => c.deletedAt === null && c.notifyBySms && c.phone
     );
   }
   ```

4. Update notifyPrimaryContact to also send SMS:
   - After sending email (regardless of success), check if contact has SMS enabled
   - If so, send SMS using L3 template
   - Update PrimaryNotifyResult to include smsSuccess?: boolean
   - Log SMS result

5. Update notifyAllContacts to also send SMS:
   - After batch email, iterate through SMS-eligible contacts
   - Send SMS to each using L4 template
   - Update BatchNotifyResult to include smsSent: number
   - Log SMS results

Important: SMS is SUPPLEMENTARY to email for L3/L4, not a replacement. Both channels are used if configured.
  </action>
  <verify>npm run typecheck passes, no lint errors</verify>
  <done>Family contacts receive SMS at L3/L4 if notifyBySms=true and phone is set</done>
</task>

<task type="auto">
  <name>Task 2: Update reminder eligibility to include phone</name>
  <files>src/lib/reminders/eligibility.ts</files>
  <action>
Update src/lib/reminders/eligibility.ts to include phone in user data:

1. Update UserNeedingReminder type to include phone:
   ```typescript
   export interface UserNeedingReminder {
     userId: string;
     profileId: string;
     email: string | null;
     phone: string | null;  // Add this field
     overdueBy: Date;
   }
   ```

2. Update findUsersNeedingReminders query to select phone from UserProfile:
   - Add `phone: profile.phone` to the returned object

This allows the reminder cron to pass phone to the notification service for SMS fallback.
  </action>
  <verify>npm run typecheck passes</verify>
  <done>UserNeedingReminder includes phone field for SMS fallback</done>
</task>

<task type="auto">
  <name>Task 3: Update reminder cron to pass phone for SMS fallback</name>
  <files>src/app/api/cron/reminders/route.ts</files>
  <action>
Update src/app/api/cron/reminders/route.ts to include phone in notification calls:

1. Update sendReminderNotification to pass userPhone:
   ```typescript
   const result: NotificationResult = await sendUserNotification({
     userProfileId: user.profileId,
     ...template,
     userEmail: user.email ?? undefined,
     userPhone: user.phone ?? undefined,  // Add this line
   });
   ```

2. Update ReminderResult type to include "sms" channel:
   ```typescript
   interface ReminderResult {
     userId: string;
     channel: "push" | "email" | "sms" | "none";
     success: boolean;
     error?: string;
   }
   ```

3. Update summary logging to include SMS count:
   ```typescript
   const smsSent = results.filter((r) => r.channel === "sms" && r.success).length;
   console.log(`[Cron] Notification summary: ${pushSent} push, ${emailSent} email, ${smsSent} sms, ${failed} failed`);
   ```

4. Update JSON response to include smsSent count

Now users with a phone number but no push subscriptions or email will receive SMS reminders.
  </action>
  <verify>npm run typecheck passes, no lint errors</verify>
  <done>Reminder cron uses SMS as fallback channel after push and email</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` passes
- [ ] `npm run lint` passes (or lint:fix if needed)
- [ ] Family contact notifications module sends SMS for L3/L4
- [ ] Reminder cron passes phone for SMS fallback
- [ ] All types updated to include SMS channel
- [ ] Phase 14 complete
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Family contacts receive SMS at L3 (primary) and L4 (all)
- User reminders fall back to SMS when no push/email
- No TypeScript errors or lint warnings
- Phase 14 complete
</success_criteria>

<output>
After completion, create `.planning/phases/14-sms-integration/14-02-SUMMARY.md`
</output>
