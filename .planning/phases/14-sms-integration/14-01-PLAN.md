---
phase: 14-sms-integration
plan: 01
type: execute
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/env.js
  - src/lib/sms.ts
  - src/lib/notifications.ts
---

<objective>
Set up Twilio SMS infrastructure and extend unified notification service.

Purpose: Enable SMS as a notification channel for user check-in reminders, falling back from push → email → SMS.
Output: Working Twilio integration with sendSMS function and updated notification service.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior relevant summaries:
@.planning/phases/06-reminder-system/06-01-SUMMARY.md
@.planning/phases/08-contact-notifications/08-01-SUMMARY.md

# Key source files:
@src/lib/notifications.ts
@src/lib/alerts/notifications.ts
@src/env.js
@prisma/schema.prisma

**Tech stack available:**
- Vercel Cron for scheduling
- Resend for email
- Web Push for push notifications
- Prisma ORM for database

**Established patterns:**
- Push-first, email-fallback notification pattern (see notifications.ts)
- Environment validation via @t3-oss/env-nextjs with Zod
- Graceful degradation when services not configured
- Contact eligibility filtering (notifyByEmail, notifyBySms fields)

**Constraining decisions:**
- Phase 12: Push-first, email-fallback notification pattern
- Phase 08: Contact filtering: deletedAt === null && notifyByEmail && email
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add phone field to UserProfile and env variables</name>
  <files>prisma/schema.prisma, src/env.js, .env.example</files>
  <action>
1. Add `phone String?` field to UserProfile model in prisma/schema.prisma (after timezone field)
   - Optional field for user's phone number for SMS reminders
   - Add comment: "// Phone number for SMS notifications (E.164 format)"

2. Add Twilio environment variables to src/env.js server schema:
   - TWILIO_ACCOUNT_SID: z.string().optional()
   - TWILIO_AUTH_TOKEN: z.string().optional()
   - TWILIO_PHONE_NUMBER: z.string().optional()
   - All optional to allow graceful degradation when not configured
   - Add comment: "// Twilio SMS - Get from https://console.twilio.com"

3. Add to runtimeEnv section:
   - TWILIO_ACCOUNT_SID: process.env.TWILIO_ACCOUNT_SID
   - TWILIO_AUTH_TOKEN: process.env.TWILIO_AUTH_TOKEN
   - TWILIO_PHONE_NUMBER: process.env.TWILIO_PHONE_NUMBER

4. Update .env.example with Twilio variables (commented out)

5. Run `npx prisma generate` to regenerate types (do NOT run db:push yet - user will do that)
  </action>
  <verify>npx prisma validate passes, npx prisma generate succeeds, npm run typecheck passes</verify>
  <done>Schema has phone field on UserProfile, env.js validates Twilio vars, types generated</done>
</task>

<task type="auto">
  <name>Task 2: Create Twilio SMS service module</name>
  <files>src/lib/sms.ts</files>
  <action>
Create src/lib/sms.ts with:

1. Import Twilio client and env:
   ```typescript
   import Twilio from "twilio";
   import type { RestException } from "twilio/lib/base/RestException";
   import { env } from "~/env";
   ```

2. Initialize Twilio client conditionally:
   ```typescript
   const client = env.TWILIO_ACCOUNT_SID && env.TWILIO_AUTH_TOKEN
     ? Twilio(env.TWILIO_ACCOUNT_SID, env.TWILIO_AUTH_TOKEN)
     : null;
   ```

3. Export SMS result type:
   ```typescript
   export interface SmsResult {
     success: boolean;
     sid?: string;
     error?: string;
   }
   ```

4. Export sendSMS function:
   - Takes `to: string` (E.164 format) and `body: string`
   - Returns Promise<SmsResult>
   - If client not configured, log warning and return { success: false, error: "SMS not configured" }
   - If TWILIO_PHONE_NUMBER not set, return { success: false, error: "Twilio phone number not configured" }
   - Try client.messages.create({ body, to, from: env.TWILIO_PHONE_NUMBER })
   - On success, return { success: true, sid: message.sid }
   - Catch errors with instanceof check for RestException pattern:
     - Log error with code, message, status
     - Return { success: false, error: `Twilio error ${error.code}: ${error.message}` }
   - For non-Twilio errors, log and return generic error

5. Add JSDoc comments explaining E.164 format requirement and trial account limitations
  </action>
  <verify>npm run typecheck passes, no lint errors</verify>
  <done>src/lib/sms.ts exports sendSMS function with proper error handling</done>
</task>

<task type="auto">
  <name>Task 3: Extend unified notification service with SMS fallback</name>
  <files>src/lib/notifications.ts</files>
  <action>
Update src/lib/notifications.ts to add SMS as third fallback channel:

1. Import sendSMS from ~/lib/sms

2. Update NotificationResult type:
   ```typescript
   export interface NotificationResult {
     channel: "push" | "email" | "sms" | "none";
     sent: number;
   }
   ```

3. Add userPhone to UserNotificationInput interface:
   ```typescript
   userPhone?: string;  // E.164 format
   ```

4. Update sendUserNotification function:
   - After email fallback fails (or no email available), try SMS
   - Check if userPhone is provided
   - Call sendSMS(userPhone, `${title}\n\n${body}`)
   - On success, log and return { channel: "sms", sent: 1 }
   - If SMS fails, fall through to "none"

5. Update getNotificationWithEmail to include SMS body:
   - Rename to getNotificationWithFallbacks
   - Add smsBody field (plain text, no HTML)
   - Keep email fallback unchanged

Important: Maintain the existing push-first, email-fallback pattern. SMS is THIRD fallback.
The order is: push → email → SMS → none
  </action>
  <verify>npm run typecheck passes, import resolves correctly</verify>
  <done>Notification service supports push → email → SMS → none fallback chain</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx prisma validate` passes
- [ ] `npm run typecheck` passes
- [ ] `npm run lint` passes (or lint:fix if needed)
- [ ] src/lib/sms.ts exports sendSMS function
- [ ] src/lib/notifications.ts has SMS fallback logic
- [ ] Environment variables added to env.js with optional validation
</verification>

<success_criteria>

- UserProfile schema has phone field
- Twilio env vars validated (optional)
- sendSMS function works with proper error handling
- Unified notification service has 3-tier fallback: push → email → SMS
- All verification checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-sms-integration/14-01-SUMMARY.md`
</output>
