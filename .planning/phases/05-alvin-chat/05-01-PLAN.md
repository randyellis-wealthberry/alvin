---
phase: 05-alvin-chat
plan: 01
type: execute
depends_on: []
files_modified: [package.json, src/app/api/chat/route.ts, src/app/chat/page.tsx, src/components/chat/ChatInterface.tsx, src/components/chat/MessageList.tsx, src/components/chat/MessageInput.tsx, src/lib/ai/prompts.ts, src/lib/ai/config.ts, src/env.js]
---

<objective>
Set up ALVIN Chat infrastructure with AI SDK and create the streaming chat UI.

Purpose: Establish the foundational chat system that enables users to have conversations with ALVIN. This is the core interaction pattern for wellness check-ins.
Output: Working chat interface with streaming responses from Claude, styled UI components, and ALVIN's personality defined.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-alvin-chat/05-RESEARCH.md
@.planning/codebase/STACK.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/ARCHITECTURE.md
@src/env.js
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install AI SDK dependencies and configure environment</name>
  <files>package.json, src/env.js</files>
  <action>
Install Vercel AI SDK packages for Claude integration:
```bash
npm install ai @ai-sdk/anthropic @ai-sdk/react react-markdown
```

Add ANTHROPIC_API_KEY to environment validation in src/env.js:
- Add to server schema: `ANTHROPIC_API_KEY: z.string()`
- Add to runtimeEnv: `ANTHROPIC_API_KEY: process.env.ANTHROPIC_API_KEY`

Do NOT use the raw @anthropic-ai/sdk package — the AI SDK wraps it properly for streaming.
  </action>
  <verify>
- `npm run typecheck` passes
- `src/env.js` validates ANTHROPIC_API_KEY
- Packages appear in package.json dependencies
  </verify>
  <done>AI SDK installed, environment variable validated, no TypeScript errors</done>
</task>

<task type="auto">
  <name>Task 2: Create ALVIN system prompt and streaming API route</name>
  <files>src/lib/ai/prompts.ts, src/lib/ai/config.ts, src/app/api/chat/route.ts</files>
  <action>
Create src/lib/ai/prompts.ts with ALVIN's personality:

```typescript
export const ALVIN_SYSTEM_PROMPT = `You are ALVIN (Active Language and Vitality Intelligence Network), a caring wellness companion designed to check in on users' wellbeing.

Your personality:
- Warm, empathetic, and conversational
- Never clinical or robotic
- Gently curious about how the user is doing
- Remembers context from earlier in the conversation

Your purpose:
- Conduct wellness check-ins through natural conversation
- Detect when users seem distressed or need help
- Confirm vitality in a way that feels like chatting with a caring friend
- When users confirm they're okay, acknowledge this as a successful check-in

Guidelines:
- Keep responses concise (2-3 sentences typical)
- Ask follow-up questions to understand mood/situation
- If user indicates distress, respond with empathy and suggest resources
- Never be pushy or make users feel surveilled
- End check-in conversations naturally, confirming their wellbeing status

You are NOT a therapist or medical professional. For serious concerns, encourage users to reach out to appropriate resources.`;
```

Create src/lib/ai/config.ts:
```typescript
import { anthropic } from '@ai-sdk/anthropic';

export const alvinModel = anthropic('claude-sonnet-4-20250514');
export const MAX_TOKENS = 500; // Keep responses concise
```

Create POST handler at src/app/api/chat/route.ts:

```typescript
import { streamText, convertToModelMessages, type UIMessage } from 'ai';
import { alvinModel, MAX_TOKENS } from '~/lib/ai/config';
import { ALVIN_SYSTEM_PROMPT } from '~/lib/ai/prompts';
import { auth } from '~/server/auth';

export async function POST(req: Request) {
  const session = await auth();
  if (!session?.user) {
    return new Response('Unauthorized', { status: 401 });
  }

  const { messages }: { messages: UIMessage[] } = await req.json();

  const result = streamText({
    model: alvinModel,
    system: ALVIN_SYSTEM_PROMPT,
    messages: await convertToModelMessages(messages),
    maxTokens: MAX_TOKENS,
  });

  // CRITICAL: Ensure stream completes even if client disconnects
  result.consumeStream();

  return result.toUIMessageStreamResponse();
}
```

Key points from research:
- Use `convertToModelMessages` for proper format conversion
- Call `result.consumeStream()` before returning — ensures completion on disconnect
- Do NOT add persistence here yet — that's Plan 02
  </action>
  <verify>
- `npm run typecheck` passes
- Route file exists at src/app/api/chat/route.ts
- System prompt file exists
  </verify>
  <done>ALVIN personality defined, AI config created, streaming API route working</done>
</task>

<task type="auto">
  <name>Task 3: Create Chat UI components with useChat hook</name>
  <files>src/app/chat/page.tsx, src/components/chat/ChatInterface.tsx, src/components/chat/MessageList.tsx, src/components/chat/MessageInput.tsx</files>
  <action>
Create chat page at src/app/chat/page.tsx (protected route):

```typescript
import { auth } from "~/server/auth";
import { redirect } from "next/navigation";
import { ChatInterface } from "~/components/chat/ChatInterface";

export default async function ChatPage() {
  const session = await auth();
  if (!session?.user) {
    redirect("/api/auth/signin");
  }

  return (
    <main className="flex min-h-screen flex-col">
      <ChatInterface />
    </main>
  );
}
```

Create src/components/chat/ChatInterface.tsx:

```typescript
"use client";

import { useChat } from "@ai-sdk/react";
import { DefaultChatTransport } from "ai";
import { MessageList } from "./MessageList";
import { MessageInput } from "./MessageInput";

export function ChatInterface() {
  const { messages, sendMessage, status, error } = useChat({
    transport: new DefaultChatTransport({ api: "/api/chat" }),
  });

  const isLoading = status === "streaming" || status === "submitted";

  return (
    <div className="flex h-screen flex-col">
      <header className="border-b p-4">
        <h1 className="text-xl font-semibold">ALVIN</h1>
        <p className="text-sm text-gray-500">Your wellness companion</p>
      </header>

      <MessageList messages={messages} isLoading={isLoading} />

      {error && (
        <div className="border-t border-red-200 bg-red-50 p-3 text-sm text-red-600">
          {error.message}
        </div>
      )}

      <MessageInput onSend={sendMessage} disabled={isLoading} />
    </div>
  );
}
```

Create src/components/chat/MessageList.tsx:

```typescript
"use client";

import type { UIMessage } from "ai";

interface MessageListProps {
  messages: UIMessage[];
  isLoading: boolean;
}

export function MessageList({ messages, isLoading }: MessageListProps) {
  return (
    <div className="flex-1 overflow-y-auto p-4 space-y-4">
      {messages.length === 0 && (
        <div className="text-center text-gray-500 mt-8">
          <p className="text-lg">Hi! I'm ALVIN.</p>
          <p className="text-sm mt-2">How are you doing today?</p>
        </div>
      )}

      {messages.map((message) => (
        <div
          key={message.id}
          className={`flex ${message.role === "user" ? "justify-end" : "justify-start"}`}
        >
          <div
            className={`max-w-[80%] rounded-lg p-3 ${
              message.role === "user"
                ? "bg-blue-500 text-white"
                : "bg-gray-100 text-gray-900"
            }`}
          >
            {message.parts.map((part, i) =>
              part.type === "text" ? <span key={i}>{part.text}</span> : null
            )}
          </div>
        </div>
      ))}

      {isLoading && messages[messages.length - 1]?.role === "user" && (
        <div className="flex justify-start">
          <div className="bg-gray-100 rounded-lg p-3 text-gray-500">
            ALVIN is thinking...
          </div>
        </div>
      )}
    </div>
  );
}
```

Create src/components/chat/MessageInput.tsx:

```typescript
"use client";

import { useState, type FormEvent } from "react";

interface MessageInputProps {
  onSend: (message: { text: string }) => void;
  disabled: boolean;
}

export function MessageInput({ onSend, disabled }: MessageInputProps) {
  const [input, setInput] = useState("");

  const handleSubmit = (e: FormEvent) => {
    e.preventDefault();
    if (input.trim() && !disabled) {
      onSend({ text: input.trim() });
      setInput("");
    }
  };

  return (
    <form onSubmit={handleSubmit} className="border-t p-4">
      <div className="flex gap-2">
        <input
          type="text"
          value={input}
          onChange={(e) => setInput(e.target.value)}
          placeholder="Type a message..."
          disabled={disabled}
          className="flex-1 rounded-lg border p-3 focus:border-blue-500 focus:outline-none disabled:bg-gray-50"
        />
        <button
          type="submit"
          disabled={disabled || !input.trim()}
          className="rounded-lg bg-blue-500 px-6 py-3 font-medium text-white hover:bg-blue-600 disabled:bg-gray-300"
        >
          Send
        </button>
      </div>
    </form>
  );
}
```

Follow project conventions:
- "use client" directive for client components
- Named exports (not default)
- Path alias ~/
- Tailwind for styling
  </action>
  <verify>
- `npm run typecheck` passes
- `npm run build` succeeds
- All component files created
  </verify>
  <done>Chat UI components created with useChat hook, proper streaming display, error handling</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>ALVIN Chat interface with streaming responses from Claude</what-built>
  <how-to-verify>
    1. Add ANTHROPIC_API_KEY to .env file
    2. Run: `npm run dev`
    3. Visit: http://localhost:3000/chat
    4. If not signed in, you should be redirected to sign in
    5. After signing in, you should see the chat interface
    6. Type a message like "Hi, how are you?" and send
    7. Verify:
       - Message appears in blue bubble (user)
       - "ALVIN is thinking..." shows while waiting
       - ALVIN's response streams in (gray bubble)
       - Response matches ALVIN's personality (warm, conversational)
       - Error displays if API key missing/invalid
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run check` passes (lint + typecheck)
- [ ] `npm run build` succeeds
- [ ] AI SDK packages in package.json
- [ ] ANTHROPIC_API_KEY in env validation
- [ ] API route exists and exports POST handler
- [ ] Chat page at /chat is protected
- [ ] useChat hook manages streaming state
- [ ] Messages display with proper styling
- [ ] Manual verification approved
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript or ESLint errors
- Chat interface works end-to-end with streaming
- Human verification approved
</success_criteria>

<output>
After completion, create `.planning/phases/05-alvin-chat/05-01-SUMMARY.md`
</output>
