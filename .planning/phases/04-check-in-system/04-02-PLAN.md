---
phase: 04-check-in-system
plan: 02
type: execute
depends_on: ["04-01"]
files_modified: [prisma/schema.prisma, src/types/alvin.ts, package.json, src/server/api/routers/passkey.ts, src/server/api/root.ts, src/app/profile/passkeys/page.tsx, src/app/profile/passkeys/passkey-setup.tsx, src/app/check-in/check-in-button.tsx]
---

<objective>
Add optional biometric verification for check-ins using WebAuthn/passkeys.

Purpose: Higher-assurance check-ins that prove the user is physically present, not just clicking a button. Important for the "dead man's switch" use case.
Output: Passkey model, registration/authentication flow, and biometric check-in option.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-check-in-system/04-01-SUMMARY.md

# Relevant source files:
@prisma/schema.prisma
@src/server/api/routers/checkin.ts
@src/app/check-in/check-in-button.tsx
@src/app/profile/profile-form.tsx

**Tech stack available:** tRPC, Prisma, Next.js App Router, React Query

**Discovery findings (SimpleWebAuthn):**
- Server: @simplewebauthn/server (generateRegistrationOptions, verifyRegistrationResponse, generateAuthenticationOptions, verifyAuthenticationResponse)
- Browser: @simplewebauthn/browser (startRegistration, startAuthentication)
- Passkey model needs: id (credentialId), publicKey (Bytes), counter, deviceType, backedUp, transports, webAuthnUserID

**Constraining decisions:**
- CheckIn model has method field including "BIOMETRIC"
- Basic check-in flow from 04-01 will be extended
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Passkey model and install SimpleWebAuthn</name>
  <files>prisma/schema.prisma, src/types/alvin.ts, package.json</files>
  <action>
Install packages:
```bash
npm install @simplewebauthn/server @simplewebauthn/browser
```

Add Passkey model to schema.prisma:
```prisma
model Passkey {
  id              String      @id  // credentialId from WebAuthn (Base64URL)
  userProfile     UserProfile @relation(fields: [userProfileId], references: [id], onDelete: Cascade)
  userProfileId   String

  // WebAuthn credential data
  publicKey       Bytes       // Credential public key
  webAuthnUserID  String      // User handle for WebAuthn
  counter         BigInt      @default(0)
  deviceType      String      // "singleDevice" | "multiDevice"
  backedUp        Boolean     @default(false)
  transports      String?     // CSV of transports: "internal,hybrid"

  createdAt       DateTime    @default(now())
  name            String?     // User-friendly name like "MacBook TouchID"

  @@index([userProfileId])
}
```

Add relation to UserProfile:
```prisma
passkeys Passkey[]
```

Run db:push to update schema.

Update src/types/alvin.ts to add DeviceType const if needed.
  </action>
  <verify>npm run db:push succeeds, npm run typecheck passes</verify>
  <done>Passkey model exists, SimpleWebAuthn packages installed, Prisma client regenerated</done>
</task>

<task type="auto">
  <name>Task 2: Create passkey tRPC router</name>
  <files>src/server/api/routers/passkey.ts, src/server/api/root.ts</files>
  <action>
Create passkey router with 5 procedures:

**list** (query): List user's registered passkeys (id, name, createdAt, deviceType)

**generateRegistrationOptions** (mutation):
- Generate WebAuthn user ID if not exists (store in UserProfile or generate per-request)
- Call generateRegistrationOptions() with rpName, rpID (from env or hostname), user info
- Store challenge temporarily (in-memory Map with 5-min expiry, keyed by challenge)
- Return options to client

**verifyRegistration** (mutation):
- Input: registration response from browser
- Retrieve stored challenge
- Call verifyRegistrationResponse()
- If verified, save Passkey to database
- Clear challenge from store
- Return success

**generateAuthenticationOptions** (mutation):
- Get user's passkeys
- Call generateAuthenticationOptions() with allowCredentials
- Store challenge
- Return options

**verifyAuthentication** (mutation):
- Input: authentication response from browser
- Retrieve stored challenge and matching passkey
- Call verifyAuthenticationResponse()
- If verified, update counter in database
- Record check-in with method="BIOMETRIC"
- Update lastCheckInAt
- Clear challenge
- Return success with check-in data

**delete** (mutation): Remove a passkey by id

Use in-memory Map for challenge storage (adequate for MVP, can upgrade to Redis later).
Store RP_ID in environment or derive from request origin.

Register router in root.ts as `passkey`.
  </action>
  <verify>npm run typecheck passes</verify>
  <done>All passkey procedures defined, router registered</done>
</task>

<task type="auto">
  <name>Task 3: Create passkey UI and biometric check-in button</name>
  <files>src/app/profile/passkeys/page.tsx, src/app/profile/passkeys/passkey-setup.tsx, src/app/check-in/check-in-button.tsx</files>
  <action>
**profile/passkeys/page.tsx** (Server Component):
- Protected route
- SSR prefetch passkey.list
- Render PasskeySetup component

**profile/passkeys/passkey-setup.tsx** (Client Component):
- List registered passkeys with delete button
- "Add Passkey" button that:
  1. Calls generateRegistrationOptions mutation
  2. Passes options to startRegistration() from @simplewebauthn/browser
  3. Calls verifyRegistration mutation with response
  4. Shows success message, invalidates list
- Handle errors (NotAllowedError = user cancelled, InvalidStateError = already registered)
- Add name input for friendly passkey name

**check-in-button.tsx** (update existing):
- Check if user has any passkeys registered (new query or include in prefetch)
- If passkeys exist, show two buttons:
  - "I'm OK" (manual check-in, existing)
  - "Biometric Check-in" (new, with fingerprint icon)
- Biometric button:
  1. Calls generateAuthenticationOptions
  2. Passes to startAuthentication()
  3. Calls verifyAuthentication
  4. Shows success, invalidates check-in list
- If no passkeys, show only manual button with small "Set up biometric →" link

Add "Passkeys" link to profile page or navigation.
  </action>
  <verify>npm run build passes</verify>
  <done>Passkey management UI works, biometric check-in button appears when passkey registered</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>WebAuthn passkey registration and biometric check-in flow</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:3000 and sign in
    3. Navigate to profile passkeys page (Settings → Passkeys or direct link)
    4. Click "Add Passkey" and complete the browser WebAuthn prompt (TouchID/FaceID/Windows Hello)
    5. Verify passkey appears in list
    6. Navigate to /check-in
    7. Verify "Biometric Check-in" button appears (alongside "I'm OK")
    8. Click "Biometric Check-in" and complete WebAuthn prompt
    9. Verify check-in recorded with "Biometric" method badge in history
    10. Delete passkey from settings, verify "Biometric" button disappears from check-in page
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` succeeds
- [ ] `npm run build` succeeds
- [ ] Passkey registration works in browser
- [ ] Biometric authentication triggers check-in
- [ ] Check-in history shows "Biometric" method
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Human verification approved
- Passkey registration and deletion work
- Biometric check-in creates record with method="BIOMETRIC"
- Phase 4 complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-check-in-system/04-02-SUMMARY.md`
</output>
