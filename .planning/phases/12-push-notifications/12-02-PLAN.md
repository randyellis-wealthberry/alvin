---
phase: 12-push-notifications
plan: 02
type: execute
depends_on: ["12-01"]
files_modified: [src/app/sw.ts, src/server/api/routers/push.ts, src/server/api/root.ts]
---

<objective>
Extend service worker with push event handlers and create tRPC router for subscription management.

Purpose: Enable receiving push notifications in the browser and provide API endpoints for clients to subscribe/unsubscribe.
Output: Service worker handles push events and displays notifications. tRPC router manages subscription lifecycle.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-push-notifications/12-RESEARCH.md
@.planning/phases/12-push-notifications/12-CONTEXT.md
@.planning/phases/12-push-notifications/12-01-SUMMARY.md (after Plan 01 completes)
@src/app/sw.ts
@src/server/api/root.ts
@src/server/api/trpc.ts

**From Plan 12-01:**
- web-push library installed
- PushSubscription model in Prisma
- src/lib/push.ts with sendPushNotification, sendPushToUser

**From Research:**
- Push handler MUST use event.waitUntil() or browser shows default notification
- notificationclick should open relevant URL (check-in screen for reminders)
- Handle push JSON payload with title, body, url, tag

**From Context:**
- Tapping reminder opens directly to check-in screen
- Notifications should be unmistakably ALVIN
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend service worker with push event handlers</name>
  <files>src/app/sw.ts</files>
  <action>
Add push event listener and notificationclick handler to existing sw.ts:

**Push event handler:**
```typescript
self.addEventListener('push', (event: PushEvent) => {
  const data = event.data?.json() ?? {
    title: 'ALVIN',
    body: 'You have a new notification',
    url: '/dashboard',
    tag: 'default',
  };

  const options: NotificationOptions = {
    body: data.body,
    icon: '/icon-192x192.png',
    badge: '/icon-192x192.png',
    tag: data.tag ?? 'default',
    requireInteraction: data.requireInteraction ?? false,
    data: { url: data.url ?? '/dashboard' },
  };

  // CRITICAL: Must use waitUntil or browser shows default notification
  event.waitUntil(
    self.registration.showNotification(data.title, options)
  );
});
```

**Notification click handler:**
```typescript
self.addEventListener('notificationclick', (event: NotificationEvent) => {
  event.notification.close();

  const url = event.notification.data?.url ?? '/dashboard';

  event.waitUntil(
    clients.matchAll({ type: 'window' }).then((clientList) => {
      // Focus existing window if open
      for (const client of clientList) {
        if (client.url.includes(url) && 'focus' in client) {
          return client.focus();
        }
      }
      // Open new window
      return clients.openWindow(url);
    })
  );
});
```

Add after serwist.addEventListeners() but note these are direct self.addEventListener calls, not Serwist methods.

**AVOID:**
- Don't remove or modify existing Serwist configuration
- Don't forget event.waitUntil() - critical for proper behavior
  </action>
  <verify>
- `npm run build` succeeds
- public/sw.js contains 'push' event listener
- public/sw.js contains 'notificationclick' event listener
  </verify>
  <done>Service worker extended with push and notificationclick handlers</done>
</task>

<task type="auto">
  <name>Task 2: Create push router with subscribe/unsubscribe endpoints</name>
  <files>src/server/api/routers/push.ts</files>
  <action>
Create new tRPC router for push subscription management:

**Procedures:**

1. `subscribe` (protectedProcedure):
   - Input: { endpoint: string, p256dh: string, auth: string, userAgent?: string }
   - Get userProfileId from session
   - Upsert PushSubscription (update if endpoint exists, create if not)
   - Return { success: true, subscriptionId: string }

2. `unsubscribe` (protectedProcedure):
   - Input: { endpoint: string }
   - Delete PushSubscription by endpoint for current user
   - Return { success: true }

3. `getStatus` (protectedProcedure):
   - No input
   - Count user's active subscriptions
   - Return { enabled: boolean, subscriptionCount: number }

4. `testNotification` (protectedProcedure):
   - No input (or optional message)
   - Send test push to all user's subscriptions
   - Use sendPushToUser from src/lib/push.ts
   - Return { sent: number, failed: number }

**Zod schemas for input validation:**
```typescript
const subscribeInput = z.object({
  endpoint: z.string().url(),
  p256dh: z.string().min(1),
  auth: z.string().min(1),
  userAgent: z.string().optional(),
});

const unsubscribeInput = z.object({
  endpoint: z.string().url(),
});
```

**AVOID:**
- Don't allow subscribing without authentication (use protectedProcedure)
- Don't expose raw subscription data to client
  </action>
  <verify>
- `npm run typecheck` passes
- Router exports pushRouter
- All four procedures defined with proper input validation
  </verify>
  <done>Push router created with subscribe, unsubscribe, getStatus, and testNotification procedures</done>
</task>

<task type="auto">
  <name>Task 3: Register push router in app router</name>
  <files>src/server/api/root.ts</files>
  <action>
Import and add pushRouter to the app router:

```typescript
import { pushRouter } from "~/server/api/routers/push";

export const appRouter = createTRPCRouter({
  // ... existing routers
  push: pushRouter,
});
```

Follow the existing pattern for other routers (post, profile, contact, etc.).

**AVOID:** Don't modify other router registrations.
  </action>
  <verify>
- `npm run typecheck` passes
- `npm run build` succeeds
- api.push.* procedures available in tRPC client types
  </verify>
  <done>Push router registered in app router, api.push.* available to clients</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run typecheck` passes
- [ ] Service worker has push event handler
- [ ] Service worker has notificationclick handler
- [ ] Push router has subscribe, unsubscribe, getStatus, testNotification procedures
- [ ] Push router registered in root.ts
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Service worker can receive and display push notifications
- API endpoints ready for client subscription flow (Plan 12-03)
</success_criteria>

<output>
After completion, create `.planning/phases/12-push-notifications/12-02-SUMMARY.md`
</output>
