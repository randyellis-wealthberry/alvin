---
phase: 12-push-notifications
plan: 01
type: execute
depends_on: []
files_modified: [package.json, prisma/schema.prisma, src/env.js, src/lib/push.ts]
---

<objective>
Set up push notification infrastructure: web-push library, VAPID keys, database schema, and server-side notification service.

Purpose: Establish the foundation for sending push notifications â€” the core plumbing that all other push features depend on.
Output: Working web-push configuration with VAPID keys, PushSubscription model in database, and push notification service ready to send.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-push-notifications/12-RESEARCH.md
@.planning/phases/12-push-notifications/12-CONTEXT.md
@.planning/phases/11-pwa-foundation/11-01-SUMMARY.md

**From Phase 11:**
- Serwist service worker set up at src/app/sw.ts
- PWA infrastructure complete
- Service worker disabled in dev mode (Turbopack incompatible)

**From Research:**
- Use `web-push` ^3.6.7 (don't hand-roll encryption)
- VAPID keys stored as environment variables
- PushSubscription model with endpoint, p256dh, auth keys

**From Context:**
- Push as primary channel, email as backup
- Simple on/off control (no granular preferences)
- User-only push (not family members)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install web-push and generate VAPID keys</name>
  <files>package.json, .env.example</files>
  <action>
Install web-push library:
```bash
npm install web-push
```

Generate VAPID keys and add to .env:
```bash
npx web-push generate-vapid-keys --json
```

Add to src/env.js:
- VAPID_PRIVATE_KEY (server-only, required)
- NEXT_PUBLIC_VAPID_PUBLIC_KEY (client-exposed, required)
- VAPID_CONTACT_EMAIL (server-only, required for VAPID "subject" - use mailto: format)

Update .env.example with placeholder values and comments explaining how to generate keys.

**AVOID:** Don't commit actual VAPID keys to git. Only add examples/placeholders.
  </action>
  <verify>
- `npm ls web-push` shows installed
- `npm run build` succeeds
- src/env.js validates new env vars
  </verify>
  <done>web-push installed, VAPID env vars defined in env.js, .env.example updated with placeholder values</done>
</task>

<task type="auto">
  <name>Task 2: Add PushSubscription model to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add PushSubscription model linked to UserProfile:

```prisma
model PushSubscription {
  id            String      @id @default(cuid())
  userProfile   UserProfile @relation(fields: [userProfileId], references: [id], onDelete: Cascade)
  userProfileId String

  // Web Push subscription data
  endpoint      String      @unique
  p256dh        String      // Public key
  auth          String      // Auth secret

  // Metadata
  userAgent     String?     // Track device/browser
  createdAt     DateTime    @default(now())

  @@index([userProfileId])
}
```

Add relation to UserProfile model:
```prisma
pushSubscriptions PushSubscription[]
```

Run `npx prisma db push` to apply schema changes.

**AVOID:** Don't create migration files - use db push for development (matches existing pattern).
  </action>
  <verify>
- `npx prisma validate` passes
- `npx prisma generate` succeeds
- PushSubscription type available in @prisma/client
  </verify>
  <done>PushSubscription model added to schema, relation to UserProfile established, database synced</done>
</task>

<task type="auto">
  <name>Task 3: Create push notification service</name>
  <files>src/lib/push.ts</files>
  <action>
Create src/lib/push.ts with web-push configuration and sendPushNotification function:

1. Import and configure web-push with VAPID details:
```typescript
import webpush from 'web-push';
import { env } from '~/env';

webpush.setVapidDetails(
  'mailto:' + env.VAPID_CONTACT_EMAIL,
  env.NEXT_PUBLIC_VAPID_PUBLIC_KEY,
  env.VAPID_PRIVATE_KEY
);
```

2. Create sendPushNotification function that:
   - Accepts subscription (endpoint, p256dh, auth) and payload (title, body, url, tag)
   - Sends via webpush.sendNotification()
   - Handles 410/404 errors by returning { success: false, reason: 'expired' }
   - Uses TTL: 24 * 60 * 60 (24 hours) and urgency: 'high'
   - Returns { success: true } on success

3. Create sendPushToUser function that:
   - Accepts userProfileId and payload
   - Fetches all PushSubscriptions for user from database
   - Sends to all subscriptions (user may have multiple devices)
   - Deletes expired subscriptions (410/404)
   - Returns count of successful sends

4. Export both functions and the configured webpush instance.

**AVOID:**
- Don't add retry logic (web-push handles retries internally)
- Don't add batch sending yet (simple per-user flow first)

**Reference:** See 12-RESEARCH.md code examples section for verified patterns.
  </action>
  <verify>
- `npm run typecheck` passes
- `npm run build` succeeds
- src/lib/push.ts exports sendPushNotification, sendPushToUser, webpush
  </verify>
  <done>Push notification service created with VAPID config, sendPushNotification, and sendPushToUser functions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npx prisma validate` passes
- [ ] `npm run typecheck` passes
- [ ] web-push is installed and importable
- [ ] PushSubscription model exists in Prisma client
- [ ] src/lib/push.ts exports sendPushNotification and sendPushToUser
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Push infrastructure ready for API endpoints (Plan 12-02)
</success_criteria>

<output>
After completion, create `.planning/phases/12-push-notifications/12-01-SUMMARY.md`
</output>
