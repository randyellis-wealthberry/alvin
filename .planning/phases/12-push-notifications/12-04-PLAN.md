---
phase: 12-push-notifications
plan: 04
type: execute
depends_on: ["12-03"]
files_modified: [src/lib/notifications.ts, src/app/api/cron/reminders/route.ts, src/server/api/routers/alert.ts]
---

<objective>
Integrate push notifications into existing notification flows: check-in reminders and escalation alerts.

Purpose: Make push the primary notification channel, with email as fallback for users without push enabled.
Output: Reminders and alerts send push first, email only if no push subscription exists.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-push-notifications/12-CONTEXT.md
@.planning/phases/12-push-notifications/12-03-SUMMARY.md (after Plan 03 completes)
@src/lib/push.ts
@src/app/api/cron/reminders/route.ts (if exists)
@src/server/api/routers/alert.ts

**From Context:**
- Push as primary channel, email as backup
- Tapping reminder opens directly to check-in screen
- Clear messaging â€” unmistakably ALVIN

**Tag taxonomy for notifications:**
- `reminder` - Check-in reminders (L1, L2)
- `escalation-L3` - Level 3 escalation (family notified)
- `escalation-L4` - Level 4 critical escalation
- `alert-cancelled` - User cancelled an escalation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unified notification service</name>
  <files>src/lib/notifications.ts</files>
  <action>
Create src/lib/notifications.ts that handles both push and email:

1. **sendUserNotification function:**
   - Input: { userProfileId, title, body, url, tag, emailSubject?, emailHtml? }
   - Try push first via sendPushToUser from src/lib/push.ts
   - If push succeeds (sent > 0), return { channel: 'push', sent: count }
   - If push fails (no subscriptions), fall back to email
   - Return { channel: 'email', sent: 1 } or { channel: 'none', sent: 0 }

2. **Notification templates:**
   ```typescript
   export const NOTIFICATION_TEMPLATES = {
     CHECKIN_REMINDER: {
       title: 'Time to Check In',
       body: "ALVIN is waiting to hear from you. Tap to confirm you're okay.",
       url: '/check-in',
       tag: 'reminder',
     },
     ESCALATION_L1: {
       title: 'Check-in Overdue',
       body: "You missed your check-in. Please respond soon.",
       url: '/check-in',
       tag: 'reminder',
     },
     ESCALATION_L2: {
       title: 'Urgent: Check-in Required',
       body: "We haven't heard from you. Your contacts will be notified soon.",
       url: '/check-in',
       tag: 'reminder',
     },
     ESCALATION_L3: {
       title: 'Family Notified',
       body: "Your emergency contacts have been alerted.",
       url: '/dashboard',
       tag: 'escalation-L3',
     },
     ESCALATION_L4: {
       title: 'Critical Alert',
       body: "All contacts have been notified. Please respond immediately.",
       url: '/check-in',
       tag: 'escalation-L4',
     },
     ALERT_CANCELLED: {
       title: "You're Back!",
       body: "Your alert has been cancelled. Your contacts have been notified.",
       url: '/dashboard',
       tag: 'alert-cancelled',
     },
   } as const;
   ```

3. **Helper to get template with email fallback:**
   ```typescript
   function getNotificationWithEmail(
     template: keyof typeof NOTIFICATION_TEMPLATES,
     overrides?: { body?: string }
   ) {
     const t = NOTIFICATION_TEMPLATES[template];
     return {
       ...t,
       ...overrides,
       emailSubject: t.title,
       emailHtml: `<p>${overrides?.body ?? t.body}</p>`,
     };
   }
   ```

**AVOID:**
- Don't send both push AND email (primary/fallback pattern)
- Don't add complex email templates yet (simple HTML is fine for now)
  </action>
  <verify>
- `npm run typecheck` passes
- src/lib/notifications.ts exports sendUserNotification and NOTIFICATION_TEMPLATES
  </verify>
  <done>Unified notification service with push-first, email-fallback pattern</done>
</task>

<task type="auto">
  <name>Task 2: Update reminder cron to use unified notifications</name>
  <files>src/app/api/cron/reminders/route.ts</files>
  <action>
Update the existing reminder cron job (or create if doesn't exist) to use the unified notification service:

1. Import sendUserNotification and NOTIFICATION_TEMPLATES from src/lib/notifications.ts

2. When sending check-in reminders:
   ```typescript
   const result = await sendUserNotification({
     userProfileId: user.profile.id,
     ...NOTIFICATION_TEMPLATES.CHECKIN_REMINDER,
   });
   console.log(`Sent ${result.channel} notification to user ${user.id}`);
   ```

3. If cron doesn't exist yet:
   - Create basic structure for check-in reminders
   - Query users whose check-in window has opened
   - Send notification to each

4. Log which channel was used for debugging/monitoring.

**AVOID:**
- Don't break existing email functionality if it exists
- Don't remove email sending code entirely (it's the fallback)
  </action>
  <verify>
- `npm run typecheck` passes
- `npm run build` succeeds
- Reminder route uses sendUserNotification
  </verify>
  <done>Reminder cron uses unified notification service with push-first pattern</done>
</task>

<task type="auto">
  <name>Task 3: Update alert router to send push on escalation</name>
  <files>src/server/api/routers/alert.ts</files>
  <action>
Update the alert router's escalation handling to send push notifications to the user:

1. Import sendUserNotification and NOTIFICATION_TEMPLATES

2. When escalating to L1:
   ```typescript
   await sendUserNotification({
     userProfileId,
     ...NOTIFICATION_TEMPLATES.ESCALATION_L1,
   });
   ```

3. When escalating to L2:
   ```typescript
   await sendUserNotification({
     userProfileId,
     ...NOTIFICATION_TEMPLATES.ESCALATION_L2,
   });
   ```

4. When escalating to L3 (after family notified):
   ```typescript
   await sendUserNotification({
     userProfileId,
     ...NOTIFICATION_TEMPLATES.ESCALATION_L3,
   });
   ```

5. When escalating to L4:
   ```typescript
   await sendUserNotification({
     userProfileId,
     ...NOTIFICATION_TEMPLATES.ESCALATION_L4,
   });
   ```

6. When user cancels alert:
   ```typescript
   await sendUserNotification({
     userProfileId,
     ...NOTIFICATION_TEMPLATES.ALERT_CANCELLED,
   });
   ```

**Note:** Family contacts still receive email only (per CONTEXT.md scope). Push is user-only.

**AVOID:**
- Don't remove existing family email notifications
- Don't add push to family contacts (out of scope)
  </action>
  <verify>
- `npm run typecheck` passes
- `npm run build` succeeds
- Alert router sends push notifications at each escalation level
  </verify>
  <done>Alert escalation sends push to user at each level, email fallback preserved</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run typecheck` passes
- [ ] src/lib/notifications.ts exports sendUserNotification
- [ ] Reminder cron uses unified notification service
- [ ] Alert router sends push at L1, L2, L3, L4 levels
- [ ] Push-first, email-fallback pattern implemented
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Push notifications integrated into reminder and alert flows
- Email fallback preserved for users without push
- Phase 12: Push Notifications complete
</success_criteria>

<output>
After completion, create `.planning/phases/12-push-notifications/12-04-SUMMARY.md`

Final summary should note:
- Push now primary notification channel
- Email preserved as fallback
- Tag taxonomy implemented for notification grouping
- Ready for Phase 13 (Offline Caching)
</output>
