---
phase: 13-offline-caching
plan: 01
type: execute
depends_on: []
files_modified: [src/app/sw.ts, src/components/offline/OfflineIndicator.tsx, src/components/offline/index.ts, src/app/dashboard/page.tsx]
---

<objective>
Implement view-only offline mode with cached activity history and clear offline indication.

Purpose: Allow users to view their dashboard and activity history when offline, while clearly indicating they're viewing cached data.
Output: Dashboard works offline with stale data, user sees clear offline banner when disconnected.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-pwa-foundation/11-01-SUMMARY.md
@src/app/sw.ts

**From STATE.md decisions:**
- View-only offline mode (no offline check-ins or chat)
- Serwist for service worker (Phase 11)
- Service worker disabled in dev mode (Turbopack incompatible)

**Current service worker state:**
- Serwist configured with `defaultCache` (comprehensive runtime caching)
- `defaultCache` already caches API GETs with NetworkFirst (10s timeout)
- Offline fallback page exists at `/offline` for navigation failures
- Push notification handlers in place

**Dashboard tRPC endpoints to cache:**
- `api.dashboard.getStatus` - User status widget
- `api.dashboard.getActivityLog` - Activity history list

**Key constraint:**
- Only view-only - no offline check-ins, chat, or mutations
- User must know they're viewing cached data
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ALVIN-specific caching rules to service worker</name>
  <files>src/app/sw.ts</files>
  <action>
Add custom runtime caching rules BEFORE the defaultCache array to handle ALVIN-specific data with longer cache retention:

1. **Create alvinCache array with custom rules:**
   - tRPC batch requests to dashboard endpoints: StaleWhileRevalidate with 7-day expiration
   - Match pattern: `/api/trpc/dashboard.*` (covers getStatus, getActivityLog)
   - Cache name: `alvin-dashboard-data`
   - Max entries: 50
   - This ensures dashboard data is always available offline

2. **Spread alvinCache before defaultCache:**
   ```typescript
   runtimeCaching: [...alvinCache, ...defaultCache],
   ```

3. **Import required Serwist classes:**
   ```typescript
   import { StaleWhileRevalidate, ExpirationPlugin } from "serwist";
   ```

**Caching strategy rationale:**
- StaleWhileRevalidate: Show cached data immediately, update in background
- 7-day expiration: Activity history is relatively stable, long cache is safe
- NetworkFirst fallback (from defaultCache) still handles other API calls

**AVOID:**
- Don't cache POST/mutation endpoints (check-ins, chat messages)
- Don't remove or modify the defaultCache (it handles other caching well)
- Don't cache auth endpoints (already excluded in defaultCache)
  </action>
  <verify>
- `npm run typecheck` passes
- Service worker imports are correct
- alvinCache rules come before defaultCache
  </verify>
  <done>Custom caching rules for dashboard data with StaleWhileRevalidate strategy</done>
</task>

<task type="auto">
  <name>Task 2: Create offline indicator component</name>
  <files>src/components/offline/OfflineIndicator.tsx, src/components/offline/index.ts</files>
  <action>
Create src/components/offline/ directory with:

**OfflineIndicator.tsx:**
A client component ("use client") that shows a banner when the user is offline:

1. **Track online status:**
   ```typescript
   const [isOnline, setIsOnline] = useState(true);

   useEffect(() => {
     // Check initial status
     setIsOnline(navigator.onLine);

     // Listen for changes
     const handleOnline = () => setIsOnline(true);
     const handleOffline = () => setIsOnline(false);

     window.addEventListener('online', handleOnline);
     window.addEventListener('offline', handleOffline);

     return () => {
       window.removeEventListener('online', handleOnline);
       window.removeEventListener('offline', handleOffline);
     };
   }, []);
   ```

2. **Render nothing when online:**
   ```typescript
   if (isOnline) return null;
   ```

3. **Render offline banner when disconnected:**
   - Fixed position at top of viewport
   - Yellow/amber warning color (not red - not an error)
   - Icon: cloud with slash or wifi off
   - Text: "You're offline — viewing cached data"
   - Subtle but visible (not intrusive)
   - Full-width banner, ~40px height
   - Z-index high enough to show above other content

**Styling:**
- Background: `bg-amber-500` or similar warm warning color
- Text: Dark for readability
- Icon: Match text color
- Consider adding subtle animation when appearing

**index.ts:**
```typescript
export { OfflineIndicator } from './OfflineIndicator';
```

**AVOID:**
- Don't use SSR for this component (browser-only APIs)
- Don't make it dismissible (user should always know when offline)
- Don't use red (that implies error, offline is just informational)
  </action>
  <verify>
- `npm run typecheck` passes
- Component exports from src/components/offline/index.ts
- Component only renders when navigator.onLine is false
  </verify>
  <done>OfflineIndicator component that shows banner when user is disconnected</done>
</task>

<task type="auto">
  <name>Task 3: Add offline indicator to dashboard</name>
  <files>src/app/dashboard/page.tsx</files>
  <action>
Import and add OfflineIndicator to the dashboard page:

1. **Import the component:**
   ```typescript
   import { OfflineIndicator } from "~/components/offline";
   ```

2. **Add at the top of the page content:**
   - Place BEFORE the main content div
   - The indicator will only render when offline
   - Position should be above everything else

3. **Example placement:**
   ```tsx
   <HydrateClient>
     <OfflineIndicator />
     <main className="...">
       {/* existing content */}
     </main>
   </HydrateClient>
   ```

**Note:** The indicator is a client component but can be imported into a server component because it will hydrate on the client.

**AVOID:**
- Don't wrap in additional client boundary (OfflineIndicator handles its own "use client")
- Don't conditionally render based on server-side checks (indicator handles its own state)
  </action>
  <verify>
- `npm run build` succeeds
- Dashboard page imports and renders OfflineIndicator
- Indicator appears when browser is offline (test in DevTools Network tab)
  </verify>
  <done>Offline indicator integrated into dashboard, visible when user loses connection</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>View-only offline mode with cached activity history and offline indicator</what-built>
  <how-to-verify>
1. Run: `npm run dev:pwa` (required for service worker)
2. Visit: http://localhost:3000/dashboard (logged in)
3. Let page fully load (service worker caches data)
4. Open DevTools > Network > check "Offline" checkbox
5. Refresh the page
6. Verify:
   - Dashboard loads with cached data (not /offline fallback page)
   - Activity log shows previously loaded entries
   - Status widget shows cached status
   - Yellow offline banner appears at top: "You're offline — viewing cached data"
7. Uncheck "Offline" in DevTools
8. Verify: Offline banner disappears
9. Refresh: Data updates from server

**Note:** If dashboard shows /offline page instead of cached content, the tRPC caching rules may need adjustment.
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run typecheck` passes
- [ ] Service worker has alvinCache rules for dashboard endpoints
- [ ] OfflineIndicator component exists and exports correctly
- [ ] Dashboard includes offline indicator
- [ ] Dashboard works offline (shows cached data, not /offline page)
- [ ] Offline banner visible when disconnected
</verification>

<success_criteria>

- All tasks completed including human verification
- All verification checks pass
- No errors or warnings introduced
- Dashboard viewable offline with cached activity data
- Clear indication when viewing cached data
- Phase 13 complete
</success_criteria>

<output>
After completion, create `.planning/phases/13-offline-caching/13-01-SUMMARY.md`

Summary should note:
- StaleWhileRevalidate caching strategy for dashboard data
- 7-day cache retention for activity history
- OfflineIndicator component with online/offline event listeners
- Ready for Phase 14 (SMS Integration)
</output>
